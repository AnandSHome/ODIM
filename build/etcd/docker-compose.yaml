version: '2.4'

services:
  etcd:
    build:
      context: ./.
      dockerfile: ./Dockerfiles/Dockerfile.etcd
      args:
          http_proxy: $http_proxy
          https_proxy: $https_proxy
    container_name: odim_etcd
    image: odim_etcd:1.0
    hostname: etcd
    restart: on-failure
    ports:
     - '2379:2379'
     - '2380:2380'
    stop_grace_period: 30s
    stop_signal: SIGTERM
    user: etcd
    domainname: etcd
    environment:
      - MEMBER_NAME=etcd
      - DATA_DIR_PATH=/opt/etcd/data
      - LISTEN_PEER_ADDR=https://0.0.0.0:2380
      - LISTEN_CLIENT_ADDR=https://0.0.0.0:2379
      - INITIAL_ADV_ADDR=https://etcd:2380
      - INITIAL_CLUSTER="etcd=https://etcd:2380"
      - INITIAL_CLUSTER_STATE=new
      - INITIAL_CLUSTER_TOKEN=odim-etcd-cluster
      - ADV_CLIENT_ADDR=https://etcd:2379
      - CLIENT_CERT_FILE=/opt/etcd/conf/etcd.crt
      - CLIENT_KEY_FILE=/opt/etcd/conf/etcd.key
      - CA_FILE=/opt/etcd/conf/rootCA.crt
      - SERVER_CERT_FILE=/opt/etcd/conf/etcd.crt
      - SERVER_KEY_FILE=/opt/etcd/conf/etcd.key
    expose:
      - '2379'
      - '2380'
    volumes:
      - '/etc/etcd/conf:/opt/etcd/conf:ro'
      - '/etc/etcd/data:/opt/etcd/data:rw'
    command: bash -c "/opt/etcd/scripts/start_etcd.sh"
